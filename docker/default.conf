# ============================================
# NGINX SITE CONFIGURATION FOR LARAVEL
# ============================================
#
# PURPOSE: Configure how Nginx serves Laravel application
# LOCATION: docker/default.conf
# COPIED TO: /etc/nginx/http.d/default.conf (in container)
#
# WHAT THIS FILE DOES:
# - Defines server block (virtual host)
# - Routes PHP requests to PHP-FPM
# - Serves static files directly
# - Handles Laravel's URL rewriting

# ============================================
# SERVER BLOCK
# ============================================
#
# server { }
#
# WHAT IT IS:
# - Virtual host configuration
# - Like Apache's VirtualHost
# - Can have multiple server blocks
#
# THIS SERVER BLOCK:
# - Listens on port 80
# - Serves Laravel from /var/www/html/public
server {
    # ========================================
    # BASIC SERVER SETTINGS
    # ========================================
    
    # listen 80;
    #
    # WHAT IT DOES:
    # - Listen for HTTP connections on port 80
    # - Default HTTP port
    #
    # ALTERNATIVES:
    # - listen 443 ssl; (HTTPS)
    # - listen 80 default_server; (default catch-all)
    # - listen [::]:80; (IPv6)
    listen 80;
    
    # server_name _;
    #
    # WHAT IT DOES:
    # - Respond to any hostname
    # - _ is wildcard (matches everything)
    #
    # WHY WILDCARD:
    # - Works with localhost
    # - Works with IP address
    # - Works with any domain
    #
    # PRODUCTION:
    # server_name api.example.com www.api.example.com;
    server_name _;
    
    # root /var/www/html/public;
    #
    # WHAT IT DOES:
    # - Set document root directory
    # - This is where Nginx looks for files
    #
    # WHY /public:
    # - Laravel's public directory
    # - index.php is here
    # - Other files (app/, config/) are hidden
    #
    # SECURITY:
    # - Only /public is web-accessible
    # - .env file is not accessible
    # - Source code is not accessible
    root /var/www/html/public;

    # index index.php index.html;
    #
    # WHAT IT DOES:
    # - Default files to serve for directories
    # - Order matters (try index.php first)
    #
    # EXAMPLE:
    # Request: http://localhost/
    # Nginx looks for:
    # 1. /public/index.php (found! use this)
    # 2. /public/index.html (not checked, already found)
    index index.php index.html;

    # charset utf-8;
    #
    # WHAT IT DOES:
    # - Set default character encoding
    # - Adds "charset=utf-8" to Content-Type header
    #
    # WHY UTF-8:
    # - Supports international characters
    # - Standard for web applications
    # - Required for proper JSON handling
    charset utf-8;

    # ========================================
    # LOCATION BLOCKS (ROUTING RULES)
    # ========================================
    
    # location / { }
    #
    # WHAT IT DOES:
    # - Handle all requests (/ matches everything)
    # - Primary routing rule
    #
    # PURPOSE:
    # - Laravel's front controller pattern
    # - All requests go through index.php
    location / {
        # try_files $uri $uri/ /index.php?$query_string;
        #
        # WHAT IT DOES:
        # - Try to serve file in order
        # - If none exist, route to index.php
        #
        # BREAKDOWN:
        # $uri: Requested URI as-is
        #   Example: /api/v1/secrets → try /public/api/v1/secrets
        #
        # $uri/: Try as directory
        #   Example: /api → try /public/api/index.html
        #
        # /index.php?$query_string: Laravel's front controller
        #   - Route through Laravel
        #   - Preserve query string
        #   Example: /api/v1/secrets?foo=bar 
        #            → /index.php?foo=bar
        #
        # FLOW EXAMPLES:
        #
        # Request: /api/v1/secrets
        # 1. Try /public/api/v1/secrets (file) → Not found
        # 2. Try /public/api/v1/secrets/ (dir) → Not found
        # 3. Route to /index.php → Laravel handles routing
        #
        # Request: /favicon.ico
        # 1. Try /public/favicon.ico (file) → Found! Serve directly
        # 2. Never reaches Laravel (more efficient)
        #
        # Request: /css/app.css
        # 1. Try /public/css/app.css (file) → Found! Serve directly
        # 2. Nginx serves static file (fast)
        try_files $uri $uri/ /index.php?$query_string;
    }

    # location = /favicon.ico { }
    #
    # WHAT IT DOES:
    # - Special handling for favicon.ico
    # - Don't log 404s (browsers always request this)
    #
    # = /favicon.ico
    #   - Exact match only
    #   - More efficient than prefix match
    #
    # access_log off;
    #   - Don't log these requests
    #   - Reduces log noise
    #
    # log_not_found off;
    #   - Don't log 404 errors
    #   - Normal for missing favicon
    location = /favicon.ico { 
        access_log off; 
        log_not_found off; 
    }
    
    # location = /robots.txt { }
    #
    # WHAT IT DOES:
    # - Same as favicon
    # - Search engines request this
    # - Don't clutter logs
    location = /robots.txt  { 
        access_log off; 
        log_not_found off; 
    }

    # error_page 404 /index.php;
    #
    # WHAT IT DOES:
    # - When file not found, route to index.php
    # - Laravel handles 404 errors
    # - Shows Laravel's 404 page
    #
    # WHY:
    # - Consistent error handling
    # - Custom error pages
    # - API returns JSON errors
    error_page 404 /index.php;

    # ========================================
    # PHP-FPM CONFIGURATION
    # ========================================
    
    # location ~ \.php$ { }
    #
    # WHAT IT DOES:
    # - Handle all .php files
    # - Route to PHP-FPM for processing
    #
    # ~ \.php$
    #   - ~ : Regular expression match
    #   - \.php$ : Ends with .php
    #   - Matches: index.php, api.php
    #   - Doesn't match: style.css, index.html
    location ~ \.php$ {
        # fastcgi_pass 127.0.0.1:9000;
        #
        # WHAT IT DOES:
        # - Send PHP requests to PHP-FPM
        # - 127.0.0.1:9000 = localhost port 9000
        #
        # PHP-FPM:
        # - Runs in same container
        # - Listens on port 9000
        # - Processes PHP and returns HTML
        #
        # FLOW:
        # Browser → Nginx (port 80) 
        #        → PHP-FPM (port 9000) 
        #        → PHP processes code
        #        → PHP-FPM returns HTML
        #        → Nginx sends to browser
        #
        # ALTERNATIVES:
        # - fastcgi_pass unix:/var/run/php-fpm.sock;
        #   Using Unix socket instead of TCP
        #   Slightly faster, but TCP is more flexible
        fastcgi_pass 127.0.0.1:9000;
        
        # fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        #
        # WHAT IT DOES:
        # - Tell PHP-FPM which file to execute
        # - Sets SCRIPT_FILENAME environment variable
        #
        # VARIABLES:
        # $realpath_root: Absolute path to root (resolves symlinks)
        #   Example: /var/www/html/public
        #
        # $fastcgi_script_name: PHP file to execute
        #   Example: /index.php
        #
        # RESULT:
        # SCRIPT_FILENAME = /var/www/html/public/index.php
        #
        # WHY $realpath_root:
        # - Resolves symbolic links
        # - Prevents security issues
        # - More reliable than $document_root
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        
        # include fastcgi_params;
        #
        # WHAT IT DOES:
        # - Include standard FastCGI parameters
        # - Sets environment variables for PHP
        #
        # VARIABLES SET:
        # - REQUEST_METHOD: GET, POST, etc.
        # - QUERY_STRING: ?foo=bar
        # - REQUEST_URI: /api/v1/secrets
        # - DOCUMENT_URI: /index.php
        # - SERVER_PROTOCOL: HTTP/1.1
        # - REMOTE_ADDR: Client IP
        # - SERVER_ADDR: Server IP
        # - SERVER_NAME: Hostname
        # - And many more...
        #
        # WHY INCLUDE:
        # - PHP needs these to process request
        # - Laravel uses these for routing
        # - Standard FastCGI setup
        include fastcgi_params;
        
        # fastcgi_hide_header X-Powered-By;
        #
        # WHAT IT DOES:
        # - Hide "X-Powered-By: PHP/8.2" header
        # - Don't reveal PHP version
        #
        # WHY:
        # - Security by obscurity
        # - Attackers can't target specific PHP version
        # - Professional appearance
        #
        # BEFORE:
        # X-Powered-By: PHP/8.2.0
        #
        # AFTER:
        # (header removed)
        fastcgi_hide_header X-Powered-By;
    }

    # ========================================
    # HIDDEN FILES PROTECTION
    # ========================================
    
    # location ~ /\.(?!well-known).* { }
    #
    # WHAT IT DOES:
    # - Block access to hidden files (.env, .git)
    # - Allow .well-known (for SSL certificates)
    #
    # BREAKDOWN:
    # ~ : Regular expression
    # /\. : Files starting with dot
    # (?!well-known) : Negative lookahead (except well-known)
    # .* : Any characters after
    #
    # BLOCKS:
    # - /.env
    # - /.git
    # - /.gitignore
    # - /.htaccess
    #
    # ALLOWS:
    # - /.well-known/acme-challenge (Let's Encrypt)
    #
    # deny all;
    #   - Return 403 Forbidden
    #   - No access at all
    #
    # WHY CRITICAL:
    # - .env contains database passwords
    # - .git contains source code
    # - Security vulnerability if exposed
    location ~ /\.(?!well-known).* {
        deny all;
    }

    # ========================================
    # REQUEST SIZE LIMIT
    # ========================================
    
    # client_max_body_size 20M;
    #
    # WHAT IT DOES:
    # - Maximum request body size
    # - Applies to POST/PUT requests
    #
    # WHY 20M:
    # - Allows reasonably large secrets
    # - Prevents abuse (huge payloads)
    # - Balance between usability and safety
    #
    # EXAMPLES:
    # - 10KB secret: Allowed
    # - 5MB secret: Allowed
    # - 50MB secret: Rejected (413 Payload Too Large)
    #
    # ADJUST FOR:
    # - File uploads: Increase to 100M
    # - API only: Decrease to 1M
    client_max_body_size 20M;
}

# ============================================
# REQUEST FLOW EXAMPLES
# ============================================
#
# EXAMPLE 1: API Request
# 
# Request: POST http://localhost:8000/api/v1/secrets
# Body: {"content": "secret", "ttl": 60}
#
# Flow:
# 1. Nginx receives on port 80
# 2. Matches location /
# 3. try_files doesn't find physical file
# 4. Routes to /index.php
# 5. Matches location ~ \.php$
# 6. Sends to PHP-FPM on 127.0.0.1:9000
# 7. PHP-FPM executes /var/www/html/public/index.php
# 8. Laravel boots and handles route
# 9. SecretController@store processes request
# 10. Returns JSON response
# 11. PHP-FPM sends back to Nginx
# 12. Nginx sends to browser
#
# ============================================
#
# EXAMPLE 2: Static File
#
# Request: GET http://localhost:8000/favicon.ico
#
# Flow:
# 1. Nginx receives on port 80
# 2. Matches location = /favicon.ico (exact match)
# 3. Returns 404 if not found
# 4. Doesn't log (access_log off)
# 5. Never reaches PHP (efficient!)
#
# ============================================
#
# EXAMPLE 3: Hidden File (BLOCKED)
#
# Request: GET http://localhost:8000/.env
#
# Flow:
# 1. Nginx receives on port 80
# 2. Matches location ~ /\.(?!well-known).*
# 3. deny all
# 4. Returns 403 Forbidden
# 5. File contents never exposed (secure!)
#
# ============================================
# TESTING CONFIGURATION
# ============================================
#
# Test Nginx config:
# docker-compose exec app nginx -t
#
# Reload Nginx:
# docker-compose exec app nginx -s reload
#
# Check Nginx status:
# docker-compose exec app ps aux | grep nginx
#
# Test API endpoint:
# curl http://localhost:8000/api/v1/secrets
#
# Test hidden file protection:
# curl http://localhost:8000/.env
# Should return: 403 Forbidden
#
# ============================================
# PRODUCTION ENHANCEMENTS
# ============================================
#
# Add for production:
#
# 1. SSL/TLS:
#    listen 443 ssl http2;
#    ssl_certificate /path/to/cert.pem;
#    ssl_certificate_key /path/to/key.pem;
#
# 2. Security headers:
#    add_header X-Frame-Options "SAMEORIGIN";
#    add_header X-Content-Type-Options "nosniff";
#    add_header X-XSS-Protection "1; mode=block";
#
# 3. HSTS (force HTTPS):
#    add_header Strict-Transport-Security "max-age=31536000";
#
# 4. Rate limiting:
#    limit_req zone=api burst=20;
#
# 5. Caching headers:
#    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
#        expires 1y;
#        add_header Cache-Control "public, immutable";
#    }
#
# ============================================